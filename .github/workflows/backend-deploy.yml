name: Backend Deploy

# Workflow for deploying Go backend to Google Cloud Run
on:
  push:
    branches:
      - develop  # Deploy automático para DEV
      - main     # Deploy para PROD (requer aprovação)
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'

  workflow_dispatch:  # Permite deploy manual

env:
  GO_VERSION: '1.23'
  REGION: 'southamerica-east1'

jobs:
  # Job para ambiente DEV
  deploy-dev:
    name: Deploy Backend to DEV
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      # Temporarily disabled - tests need fixes
      # - name: Run tests
      #   working-directory: ./backend
      #   run: |
      #     go test -v ./...

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_DEV }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Create Firebase config
        working-directory: ./backend
        run: |
          mkdir -p config
          echo '${{ secrets.FIREBASE_ADMIN_SDK_DEV }}' > config/firebase-adminsdk.json

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Create Artifact Registry repository if not exists
        run: |
          gcloud artifacts repositories create backend \
            --repository-format=docker \
            --location=${{ env.REGION }} \
            --description="Backend API Docker images" \
            --project=${{ secrets.GCP_PROJECT_ID_DEV }} || true

      - name: Build and push Docker image
        working-directory: ./backend
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID_DEV }}/backend/backend-api:latest .
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID_DEV }}/backend/backend-api:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy backend-api \
            --image ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID_DEV }}/backend/backend-api:latest \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --set-env-vars "ENVIRONMENT=development,FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID_DEV }},GCS_BUCKET_NAME=${{ secrets.GCS_BUCKET_NAME_DEV }},GIN_MODE=debug" \
            --project=${{ secrets.GCP_PROJECT_ID_DEV }}

      - name: Get service URL
        run: |
          URL=$(gcloud run services describe backend-api \
            --platform managed \
            --region ${{ env.REGION }} \
            --format 'value(status.url)' \
            --project=${{ secrets.GCP_PROJECT_ID_DEV }})
          echo "Backend DEV deployed to: $URL"
          echo "::notice title=Deployment Success::Backend DEV deployed to $URL"

  # Job para ambiente PROD (requer aprovação manual)
  deploy-prod:
    name: Deploy Backend to PROD
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://api.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      # Temporarily disabled - tests need fixes
      # - name: Run tests
      #   working-directory: ./backend
      #   run: |
      #     go test -v ./...

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Create Firebase config
        working-directory: ./backend
        run: |
          mkdir -p config
          echo '${{ secrets.FIREBASE_ADMIN_SDK_PROD }}' > config/firebase-adminsdk.json

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Create Artifact Registry repository if not exists
        run: |
          gcloud artifacts repositories create backend \
            --repository-format=docker \
            --location=${{ env.REGION }} \
            --description="Backend API Docker images" \
            --project=${{ secrets.GCP_PROJECT_ID_PROD }} || true

      - name: Build and push Docker image
        working-directory: ./backend
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID_PROD }}/backend/backend-api:latest .
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID_PROD }}/backend/backend-api:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy backend-api \
            --image ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID_PROD }}/backend/backend-api:latest \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --update-env-vars "ENVIRONMENT=production,FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID_PROD }},GCS_BUCKET_NAME=${{ secrets.GCS_BUCKET_NAME_PROD }},GIN_MODE=release" \
            --project=${{ secrets.GCP_PROJECT_ID_PROD }}

      - name: Get service URL
        run: |
          URL=$(gcloud run services describe backend-api \
            --platform managed \
            --region ${{ env.REGION }} \
            --format 'value(status.url)' \
            --project=${{ secrets.GCP_PROJECT_ID_PROD }})
          echo "Backend PROD deployed to: $URL"
          echo "::notice title=Deployment Success::Backend PROD deployed to $URL"
